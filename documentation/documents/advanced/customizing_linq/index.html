<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Extending Marten's Linq Support</title>
    <link href="/v3/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/v3/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.13.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/v3/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/v3/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/v3/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/v3/documentation/documents/advanced/existing_transactions" title="Enlisting in Existing Transactions">Previous</a></li>
                <li><a href="/v3/documentation/documents/advanced/identitymap" title="Identity Map Mechanics">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/v3/">Marten</a></li><li><a href="/v3/documentation">Documentation</a></li><li><a href="/v3/documentation/documents">Marten as Document Db</a></li><li><a href="/v3/documentation/documents/advanced">Advanced Topics</a></li><li class="active">Extending Marten&#x27;s Linq Support</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/v3/documentation/documents/advanced/identitymap">Identity Map Mechanics</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/v3/documentation/documents/advanced/existing_transactions">Enlisting in Existing Transactions</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Extending Marten's Linq Support <a href="https://github.com/jasperfx/marten/blob/3.13/documentation/documentation/documents/advanced/customizing_linq.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--Title:Extending Marten's Linq Support-->
<div class="alert alert-info" role="alert">
The Linq parsing and translation to Postgresql JSONB queries, not to mention Marten's own helpers and model, are pretty involved and this guide isn't exhaustive. Please feel free to ask for help in Marten's
Gitter room linked above if there's any Linq customization or extension that you need.
</div>
<p>Marten allows you to add Linq parsing and querying support for your own custom methods.
Using the (admittedly contrived) example from Marten's tests, say that you want to reuse a small part of a <code>Where()</code> clause across
different queries for &quot;IsBlue().&quot; First, write the method you want to be recognized by Marten's Linq support:</p>
 <pre><code class="language-csharp">&#xD;&#xA;public class IsBlue : IMethodCallParser&#xD;&#xA;{&#xD;&#xA;    private static readonly PropertyInfo _property = ReflectionHelper.GetProperty&lt;ColorTarget&gt;(x =&gt; x.Color);&#xD;&#xA;&#xD;&#xA;    public bool Matches(MethodCallExpression expression)&#xD;&#xA;    {&#xD;&#xA;        return expression.Method.Name == nameof(CustomExtensions.IsBlue);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    public IWhereFragment Parse(IQueryableDocument mapping, ISerializer serializer, MethodCallExpression expression)&#xD;&#xA;    {&#xD;&#xA;        var locator = mapping.FieldFor(new MemberInfo[] {_property}).SqlLocator;&#xD;&#xA;&#xD;&#xA;        return new WhereFragment($&quot;{locator} = &#x27;Blue&#x27;&quot;);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;</code></pre>
<p>Note a couple things here:</p>
<ol>
<li>If you're only using the method for Linq queries, it technically doesn't have to be implemented and never actually runs</li>
<li>The methods do not have to be extension methods, but we're guessing that will be the most common usage of this</li>
</ol>
<p>Now, to create a custom Linq parser for the <code>IsBlue()</code> method, you need to create a custom implementation of the <code>IMethodCallParser</code>
interface shown below:</p>
 <pre><code class="language-csharp">&#xD;&#xA;public interface IMethodCallParser&#xD;&#xA;{&#xD;&#xA;    bool Matches(MethodCallExpression expression);&#xD;&#xA;&#xD;&#xA;    IWhereFragment Parse(IQueryableDocument mapping, ISerializer serializer, MethodCallExpression expression);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>The <code>IMethodCallParser</code> interface needs to match on method expressions that it could parse, and be able to turn the Linq expression into
part of a Postgresql &quot;where&quot; clause. The custom Linq parser for <code>IsBlue()</code> is shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;public static bool IsBlue(this ColorTarget target)&#xD;&#xA;{&#xD;&#xA;    return target.Color == &quot;Blue&quot;;&#xD;&#xA;}&#xD;&#xA;</code></pre>
<p>Lastly, to plug in our new parser, we can add that to the <code>StoreOptions</code> object that we use to bootstrap a new <code>DocumentStore</code> as shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;[Fact]&#xD;&#xA;public void query_with_custom_parser()&#xD;&#xA;{&#xD;&#xA;    using (var store = DocumentStore.For(_ =&gt;&#xD;&#xA;    {&#xD;&#xA;        _.Connection(ConnectionSource.ConnectionString);&#xD;&#xA;&#xD;&#xA;        // IsBlue is a custom parser I used for testing this&#xD;&#xA;        _.Linq.MethodCallParsers.Add(new IsBlue());&#xD;&#xA;        _.AutoCreateSchemaObjects = AutoCreate.All;&#xD;&#xA;&#xD;&#xA;        // This is just to isolate the test&#xD;&#xA;        _.DatabaseSchemaName = &quot;isblue&quot;;&#xD;&#xA;    }))&#xD;&#xA;    {&#xD;&#xA;&#xD;&#xA;        store.Advanced.Clean.CompletelyRemoveAll();&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;        var targets = new List&lt;ColorTarget&gt;();&#xD;&#xA;        for (var i = 0; i &lt; 25; i&#x2B;&#x2B;)&#xD;&#xA;        {&#xD;&#xA;            targets.Add(new ColorTarget {Color = &quot;Blue&quot;});&#xD;&#xA;            targets.Add(new ColorTarget {Color = &quot;Green&quot;});&#xD;&#xA;            targets.Add(new ColorTarget {Color = &quot;Red&quot;});&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        var count = targets.Where(x =&gt; x.IsBlue()).Count();&#xD;&#xA;&#xD;&#xA;        targets.Each(x =&gt; x.Id = Guid.NewGuid());&#xD;&#xA;&#xD;&#xA;        store.BulkInsert(targets.ToArray());&#xD;&#xA;&#xD;&#xA;        using (var session = store.QuerySession())&#xD;&#xA;        {&#xD;&#xA;            session.Query&lt;ColorTarget&gt;().Count(x =&gt; CustomExtensions.IsBlue(x))&#xD;&#xA;                .ShouldBe(count);&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;</code></pre>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/v3/documentation/documents/advanced/existing_transactions">Enlisting in Existing Transactions</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/v3/documentation/documents/advanced/identitymap">Identity Map Mechanics</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/v3/content/prism.js"></script>
    <script type="text/javascript" src="/v3/content/sidebar.js"></script>
    <script type="text/javascript" src="/v3/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
