<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Identity Map Mechanics</title>
    <link href="/v3/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/v3/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.13.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/v3/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/v3/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/v3/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/v3/documentation/documents/advanced/customizing_linq" title="Extending Marten's Linq Support">Previous</a></li>
                <li><a href="/v3/documentation/documents/advanced/javascript_transformations" title="Javascript Transformations">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/v3/">Marten</a></li><li><a href="/v3/documentation">Documentation</a></li><li><a href="/v3/documentation/documents">Marten as Document Db</a></li><li><a href="/v3/documentation/documents/advanced">Advanced Topics</a></li><li class="active">Identity Map Mechanics</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/v3/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/v3/documentation/documents/advanced/javascript_transformations">Javascript Transformations</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/v3/documentation/documents/advanced/customizing_linq">Extending Marten's Linq Support</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Identity Map Mechanics <a href="https://github.com/jasperfx/marten/blob/3.13/documentation/documentation/documents/advanced/identitymap.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--title:Identity Map Mechanics-->
<p><strong>Identity Map:</strong></p>
<p><em>Ensures that each object gets loaded only once by keeping every loaded object in a map. Looks up objects using the map when referring to them.</em></p>
<p><a href="http://martinfowler.com/eaaCatalog/identityMap.html">Martin Fowler</a></p>
<p>Marten's <code>IDocumentSession</code> implements the <a href="https://en.wikipedia.org/wiki/Identity_map_pattern"><em>Identity Map</em></a> pattern that seeks to cache documents loaded by id. This behavior can be very valuable, for example, in handling web requests or service bus messages when many different objects or functions may need to access the same logical document. Using the identity map mechanics allows the application to easily share data and avoid the extra database access hits -- as long as the <code>IDocumentSession</code> is scoped to the web request.</p>
<pre><code class="language-csharp">&#xD;&#xA;public void using_identity_map()&#xD;&#xA;{&#xD;&#xA;    var user = new User { FirstName = &quot;Tamba&quot;, LastName = &quot;Hali&quot; };&#xD;&#xA;    theStore.BulkInsert(new[] { user });&#xD;&#xA;&#xD;&#xA;    // Open a document session with the identity map&#xD;&#xA;    using (var session = theStore.OpenSession())&#xD;&#xA;    {&#xD;&#xA;        session.Load&lt;User&gt;(user.Id)&#xD;&#xA;            .ShouldBeTheSameAs(session.Load&lt;User&gt;(user.Id));&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>Do note that using the identity map functionality can be wasteful if you aren't able to take advantage of the identity map caching in a session. In those cases, you may want to either use the <code>IDocumentStore.LightweightSession()</code> which forgos the identity map functionality, or use the read only <code>IQuerySession</code> alternative. RavenDb users will note that Marten does not (yet) support any notion of <code>Evict()</code> to manually remove documents from identity map tracking to avoid memory usage problems. Our hope is that the existence of the lightweight session and the read only interface will alleviate the memory explosion problems that you can run into with naive usage of identity maps or the dirty checking when fetching a large number of documents.</p>
<p>The Identity Map functionality is applied to all documents loaded by Id or Linq queries with <code>IQuerySession/IDocumentSession.Query&lt;T&gt;()</code>. <strong>Documents loaded by user-supplied SQL in the <code>IQuerySession.Query&lt;T&gt;(sql)</code> mechanism bypass the Identity Map functionality.</strong></p>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/v3/documentation/documents/advanced/customizing_linq">Extending Marten's Linq Support</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/v3/documentation/documents/advanced/javascript_transformations">Javascript Transformations</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/v3/content/prism.js"></script>
    <script type="text/javascript" src="/v3/content/sidebar.js"></script>
    <script type="text/javascript" src="/v3/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
