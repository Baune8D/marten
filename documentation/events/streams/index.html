<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Querying Event and Stream Data</title>
    <link href="/v3/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/v3/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.13.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/v3/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/v3/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/v3/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/v3/documentation/events/appending" title="Appending Events">Previous</a></li>
                <li><a href="/v3/documentation/events/projections" title="Projections">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/v3/">Marten</a></li><li><a href="/v3/documentation">Documentation</a></li><li><a href="/v3/documentation/events">Marten as Event Store</a></li><li class="active">Querying Event and Stream Data</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/v3/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/v3/documentation/events/projections">Projections</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/v3/documentation/events/appending">Appending Events</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Querying Event and Stream Data <a href="https://github.com/jasperfx/marten/blob/3.13/documentation/documentation/events/streams.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--Title:Querying Event and Stream Data-->
<!--Url:streams-->
<h2 id="fetch-events-for-a-stream">Fetch Events for a Stream</h2>
<p>You can retrieve the events for a single stream at any time with the <code>IEventStore.FetchStream()</code> methods shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;public void load_event_stream(IDocumentSession session, Guid streamId)&#xD;&#xA;{&#xD;&#xA;    // Fetch *all* of the events for this stream&#xD;&#xA;    var events1 = session.Events.FetchStream(streamId);&#xD;&#xA;&#xD;&#xA;    // Fetch the events for this stream up to and including version 5&#xD;&#xA;    var events2 = session.Events.FetchStream(streamId, 5);&#xD;&#xA;&#xD;&#xA;    // Fetch the events for this stream at this time yesterday&#xD;&#xA;    var events3 = session.Events&#xD;&#xA;                .FetchStream(streamId, timestamp: DateTime.UtcNow.AddDays(-1));&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;public async Task load_event_stream_async(IDocumentSession session, Guid streamId)&#xD;&#xA;{&#xD;&#xA;    // Fetch *all* of the events for this stream&#xD;&#xA;    var events1 = await session.Events.FetchStreamAsync(streamId);&#xD;&#xA;&#xD;&#xA;    // Fetch the events for this stream up to and including version 5&#xD;&#xA;    var events2 = await session.Events.FetchStreamAsync(streamId, 5);&#xD;&#xA;&#xD;&#xA;    // Fetch the events for this stream at this time yesterday&#xD;&#xA;    var events3 = await session.Events&#xD;&#xA;                .FetchStreamAsync(streamId, timestamp: DateTime.UtcNow.AddDays(-1));&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>The data returned is a list of <code>IEvent</code> objects, where each is a strongly-typed <code>Event&lt;T&gt;</code> object shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;public interface IEvent&#xD;&#xA;{&#xD;&#xA;    Guid Id { get; set; }&#xD;&#xA;    int Version { get; set; }&#xD;&#xA;&#xD;&#xA;    long Sequence { get; set; }&#xD;&#xA;&#xD;&#xA;    object Data { get; }&#xD;&#xA;&#xD;&#xA;    Guid StreamId { get; set; }&#xD;&#xA;&#xD;&#xA;    string StreamKey { get; set; }&#xD;&#xA;&#xD;&#xA;    DateTimeOffset Timestamp { get; set; }&#xD;&#xA;&#xD;&#xA;    string TenantId { get; set; }&#xD;&#xA;&#xD;&#xA;    void Apply&lt;TAggregate&gt;(TAggregate state, IAggregator&lt;TAggregate&gt; aggregator)&#xD;&#xA;        where TAggregate : class;&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<h2 id="stream-state">Stream State</h2>
<p>If you just need to check on the state of an event stream - what version (effectively the number of events in the stream) it is and what, if any, aggregate type it represents - you can use the <code>IEventStore.FetchStreamState()/FetchStreamStateAsync()</code> methods or <code>IBatchQuery.Events.FetchStreamState()</code>, as shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;public class fetching_stream_state: IntegrationContextWithIdentityMap&lt;NulloIdentityMap&gt;&#xD;&#xA;{&#xD;&#xA;    private Guid theStreamId;&#xD;&#xA;&#xD;&#xA;    public fetching_stream_state(DefaultStoreFixture fixture) : base(fixture)&#xD;&#xA;    {&#xD;&#xA;        var joined = new MembersJoined { Members = new string[] { &quot;Rand&quot;, &quot;Matt&quot;, &quot;Perrin&quot;, &quot;Thom&quot; } };&#xD;&#xA;        var departed = new MembersDeparted { Members = new[] { &quot;Thom&quot; } };&#xD;&#xA;&#xD;&#xA;        theStreamId = theSession.Events.StartStream&lt;Quest&gt;(joined, departed).Id;&#xD;&#xA;        theSession.SaveChanges();&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    [Fact]&#xD;&#xA;    public void can_fetch_the_stream_version_and_aggregate_type()&#xD;&#xA;    {&#xD;&#xA;        var state = theSession.Events.FetchStreamState(theStreamId);&#xD;&#xA;&#xD;&#xA;        state.Id.ShouldBe(theStreamId);&#xD;&#xA;        state.Version.ShouldBe(2);&#xD;&#xA;        state.AggregateType.ShouldBe(typeof(Quest));&#xD;&#xA;        state.LastTimestamp.ShouldNotBe(DateTime.MinValue);&#xD;&#xA;        state.Created.ShouldNotBe(DateTime.MinValue);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    [Fact]&#xD;&#xA;    public async Task can_fetch_the_stream_version_and_aggregate_type_async()&#xD;&#xA;    {&#xD;&#xA;        var state = await theSession.Events.FetchStreamStateAsync(theStreamId).ConfigureAwait(false);&#xD;&#xA;&#xD;&#xA;        state.Id.ShouldBe(theStreamId);&#xD;&#xA;        state.Version.ShouldBe(2);&#xD;&#xA;        state.AggregateType.ShouldBe(typeof(Quest));&#xD;&#xA;        state.LastTimestamp.ShouldNotBe(DateTime.MinValue);&#xD;&#xA;        state.Created.ShouldNotBe(DateTime.MinValue);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    [Fact]&#xD;&#xA;    public async Task can_fetch_the_stream_version_through_batch_query()&#xD;&#xA;    {&#xD;&#xA;        var batch = theSession.CreateBatchQuery();&#xD;&#xA;&#xD;&#xA;        var stateTask = batch.Events.FetchStreamState(theStreamId);&#xD;&#xA;&#xD;&#xA;        await batch.Execute().ConfigureAwait(false);&#xD;&#xA;&#xD;&#xA;        var state = await stateTask.ConfigureAwait(false);&#xD;&#xA;&#xD;&#xA;        state.Id.ShouldBe(theStreamId);&#xD;&#xA;        state.Version.ShouldBe(2);&#xD;&#xA;        state.AggregateType.ShouldBe(typeof(Quest));&#xD;&#xA;        state.LastTimestamp.ShouldNotBe(DateTime.MinValue);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    [Fact]&#xD;&#xA;    public async Task can_fetch_the_stream_events_through_batch_query()&#xD;&#xA;    {&#xD;&#xA;        var batch = theSession.CreateBatchQuery();&#xD;&#xA;&#xD;&#xA;        var eventsTask = batch.Events.FetchStream(theStreamId);&#xD;&#xA;&#xD;&#xA;        await batch.Execute().ConfigureAwait(false);&#xD;&#xA;&#xD;&#xA;        var events = await eventsTask.ConfigureAwait(false);&#xD;&#xA;&#xD;&#xA;        events.Count.ShouldBe(2);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>Furthermore, <code>StreamState</code> contains metadata for when the stream was created, <code>StreamState.Created</code>, and when the stream was last updated, <code>StreamState.LastTimestamp</code>.</p>
<h2 id="fetch-a-single-event">Fetch a Single Event</h2>
<p>You can fetch the information for a single event by id, including its version number within the stream, by using <code>IEventStore.Load()</code> as shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;public void load_a_single_event_synchronously(IDocumentSession session, Guid eventId)&#xD;&#xA;{&#xD;&#xA;    // If you know what the event type is already&#xD;&#xA;    var event1 = session.Events.Load&lt;MembersJoined&gt;(eventId);&#xD;&#xA;&#xD;&#xA;    // If you do not know what the event type is&#xD;&#xA;    var event2 = session.Events.Load(eventId);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;public async Task load_a_single_event_asynchronously(IDocumentSession session, Guid eventId)&#xD;&#xA;{&#xD;&#xA;    // If you know what the event type is already&#xD;&#xA;    var event1 = await session.Events.LoadAsync&lt;MembersJoined&gt;(eventId)&#xD;&#xA;        .ConfigureAwait(false);&#xD;&#xA;&#xD;&#xA;    // If you do not know what the event type is&#xD;&#xA;    var event2 = await session.Events.LoadAsync(eventId)&#xD;&#xA;        .ConfigureAwait(false);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<h2 id="querying-directly-against-event-data">Querying Directly Against Event Data</h2>
<p>We urge caution about this functionality because it requires a search against the entire <code>mt_events</code> table. To issue Linq queries against any specific event type, use the method shown below:</p>
<pre><code class="language-csharp">&#xD;&#xA;[Fact]&#xD;&#xA;public void can_query_against_event_type()&#xD;&#xA;{&#xD;&#xA;    theSession.Events.StartStream&lt;Quest&gt;(joined1, departed1);&#xD;&#xA;    theSession.Events.StartStream&lt;Quest&gt;(joined2, departed2);&#xD;&#xA;&#xD;&#xA;    theSession.SaveChanges();&#xD;&#xA;&#xD;&#xA;    theSession.Events.QueryRawEventDataOnly&lt;MembersJoined&gt;().Count().ShouldBe(2);&#xD;&#xA;    theSession.Events.QueryRawEventDataOnly&lt;MembersJoined&gt;().ToArray().SelectMany(x =&gt; x.Members).Distinct()&#xD;&#xA;        .OrderBy(x =&gt; x)&#xD;&#xA;        .ShouldHaveTheSameElementsAs(&quot;Egwene&quot;, &quot;Matt&quot;, &quot;Nynaeve&quot;, &quot;Perrin&quot;, &quot;Rand&quot;, &quot;Thom&quot;);&#xD;&#xA;&#xD;&#xA;    theSession.Events.QueryRawEventDataOnly&lt;MembersDeparted&gt;().Where(x =&gt; x.Members.Contains(&quot;Matt&quot;))&#xD;&#xA;        .Single().Id.ShouldBe(departed2.Id);&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>You can use any Linq operator that Marten supports to query against event data. We think that this functionality is probably more useful for diagnostics or troubleshooting rather than something you would routinely use to support your application. We recommend that you favor event projection views over querying within the raw event table.</p>
<p>With Marten 1.0, you can issue queries with Marten's full Linq support against the raw event data with this method:</p>
<pre><code class="language-csharp">&#xD;&#xA;public void example_of_querying_for_event_data(IDocumentSession session, Guid stream)&#xD;&#xA;{&#xD;&#xA;    var events = session.Events.QueryAllRawEvents()&#xD;&#xA;        .Where(x =&gt; x.StreamId == stream)&#xD;&#xA;        .OrderBy(x =&gt; x.Sequence)&#xD;&#xA;        .ToList();&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;</code></pre>
<p>This mechanism will allow you to query by any property of the <code>IEvent</code> interface shown above.</p>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/v3/documentation/events/appending">Appending Events</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/v3/documentation/events/projections">Projections</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/v3/content/prism.js"></script>
    <script type="text/javascript" src="/v3/content/sidebar.js"></script>
    <script type="text/javascript" src="/v3/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
