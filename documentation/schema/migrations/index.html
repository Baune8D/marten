<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="generator" content="Bootply" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Marten - Schema Migrations and Patches</title>
    <link href="/v3/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/prism.css" rel="stylesheet" type="text/css" />
    <link href="/v3/content/theme.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" />

    <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

    <!-- CSS code from Bootply.com editor -->
    <link href="/v3/content/affix.css" rel="stylesheet" type="text/css" />
</head>

<!-- HTML code from Bootply.com editor -->

<body>
    <a href="https://github.com/jasperfx/marten"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

    <nav class="navbar navbar-default navbar-fixed-top" role="banner">
        <div class="container">
            <div class="navbar-header">
                <a href="/marten" class="navbar-brand">Marten 3.13.1</a>
            </div>
            <nav class="collapse navbar-collapse" role="navigation">
                <ul class="nav navbar-nav pull-right">
                    <li>
                        <a href="/v3/getting_started">Getting Started</a>
                    </li>
                    <li>
                        <a href="/v3/documentation">Documentation</a>
                    </li>
                    <li>
                        <a href="/v3/migration_guide">Migration Guide</a>
                    </li>
                    <li>
                        <a href="https://gitter.im/jasperfx/marten?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/marten" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
                    </li>
                    <li>
                        <a href="https://twitter.com/marten_lib?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @marten_lib</a>
                        <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    </li>
                    <li><a href="/v3/documentation/schema/schema" title="Configuring the Database Schema">Previous</a></li>
                <li><a href="/v3/documentation/schema/exporting" title="Exporting the Schema Definition">Next</a></li>
                </ul>
                <div class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input id="search" type="search" class="form-control" placeholder="Search">
                    </div>
                </div>
            </nav>
        </div>
    </nav>
    <div class="container">
        <nav class="navbar-inverse">
            <ol class="breadcrumb"><li><a href="/v3/">Marten</a></li><li><a href="/v3/documentation">Documentation</a></li><li><a href="/v3/documentation/schema">Marten and the Postgresql Schema</a></li><li class="active">Schema Migrations and Patches</li></ol>
        </nav>
    </div>
    <!--main-->
    <div class="container">
        <div class="row">
            <!--left-->

            <div class="col-md-3" id="leftCol">

                <img src="/content/images/emblem.png" width="80%" align="middle" />
                <br />
                <ul class="nav nav-stacked affix" id="sidebar"></ul>
                <h3 class="no-margin">Next</h3><p><a href="/v3/documentation/schema/exporting">Exporting the Schema Definition</a></p>
                    <h3 class="no-margin">Previous</h3><a href="/v3/documentation/schema/schema">Configuring the Database Schema</a></p>
                </ul>
            </div><!--/left-->
            <!--right-->
            <div class="col-md-9">
                <h1>Schema Migrations and Patches <a href="https://github.com/jasperfx/marten/blob/3.13/documentation/documentation/schema/migrations.md" class="text-muted small pull-right fa fa-github" style="margin-top: 10px"> Edit on GitHub</a></h1>

                <hr />
                <div id="main-pane">
                    <!--Title: Schema Migrations and Patches-->
<p>While it's going to be far less mechanical work than persisting an application via relational tables, Marten still needs to create
matching schema objects in your Postgresql database and you'll need some mechanism for keeping your database schema up to date
with the Marten <code>StoreOptions</code> configuration in your system.</p>
<h2 id="development-time-with-auto-create-mode">Development Time with &quot;Auto Create&quot; Mode</h2>
<p>As long as you have rights to alter your Postgresql database, you can happily set up Marten in one of the permissive &quot;AutoCreate&quot;
modes and not worry about schema changes at all as you happily code new features and change existing document types:</p>
<pre><code class="language-csharp">&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    // Marten will create any new objects that are missing,&#xD;&#xA;    // attempt to update tables if it can, but drop and replace&#xD;&#xA;    // tables that it cannot patch.&#xD;&#xA;    _.AutoCreateSchemaObjects = AutoCreate.All;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    // Marten will create any new objects that are missing or&#xD;&#xA;    // attempt to update tables if it can. Will *never* drop&#xD;&#xA;    // any existing objects, so no data loss&#xD;&#xA;    _.AutoCreateSchemaObjects = AutoCreate.CreateOrUpdate;&#xD;&#xA;&#xD;&#xA;&#xD;&#xA;    // Marten will create missing objects on demand, but&#xD;&#xA;    // will not change any existing schema objects&#xD;&#xA;    _.AutoCreateSchemaObjects = AutoCreate.CreateOnly;&#xD;&#xA;&#xD;&#xA;    // Marten will not create or update any schema objects&#xD;&#xA;    // and throws an exception in the case of a schema object&#xD;&#xA;    // not reflecting the Marten configuration&#xD;&#xA;    _.AutoCreateSchemaObjects = AutoCreate.None;&#xD;&#xA;});&#xD;&#xA;</code></pre>
<p>As long as you're using a permissive auto creation mode (i.e., not <em>None</em>), you should be able to code in your application model
and let Marten change your development database as needed behind the scenes to match the active configuration.</p>
<h2 id="exporting-schema-patches">Exporting Schema Patches</h2>
<p>It's somewhat unlikely that any self-respecting DBA is going to allow your application to have rights to execute schema changes programmatically,
so we're stuck needing some kind of migration strategy as we add document types, Javascript transformations, and retrofit indexes.
Fortunately, we've got a decent start on doing just that with the <code>IDocumentStore.Schema.WritePatch(string file)</code> command that
will dump a SQL file with all the <a href="https://en.wikipedia.org/wiki/Data_definition_language">Data Definition Language</a> (DDL) commands necessary
to bring a database schema into alignment with the current Marten configuration.</p>
<p>In usage, you would need to tell Marten about every possible document type, any event store usage, and any
<a href="/v3/documentation/documents/advanced/javascript_transformations">javascript transorms</a> so that Marten
&quot;knows&quot; how to make the full comparison:</p>
<pre><code class="language-csharp">&#xD;&#xA;var store = DocumentStore.For(_ =&gt;&#xD;&#xA;{&#xD;&#xA;    // This is enough to tell Marten that the User&#xD;&#xA;    // document is persisted and needs schema objects&#xD;&#xA;    _.Schema.For&lt;User&gt;();&#xD;&#xA;&#xD;&#xA;    // Lets Marten know that the event store is active&#xD;&#xA;    _.Events.AddEventType(typeof(MembersJoined));&#xD;&#xA;&#xD;&#xA;    // Tell Marten about all the javascript functions&#xD;&#xA;    _.Transforms.LoadFile(&quot;default_username.js&quot;);&#xD;&#xA;});&#xD;&#xA;</code></pre>
<p>Then to write a patch DDL file, bootstrap your <code>IDocumentStore</code> pointing to the database connection you
want to update, and use:</p>
<pre><code class="language-csharp">&#xD;&#xA;store.Schema.WritePatch(&quot;1.initial.sql&quot;);&#xD;&#xA;</code></pre>
<p>The command above will generate a file called &quot;1.initial.sql&quot; to update the schema, and a second file called
&quot;1.initial.drop.sql&quot; that attempts to rollback all of the changes from &quot;1.initial.sql.&quot; Today, the <code>WritePatch()</code>
mechanism covers:</p>
<ol>
<li>Creates any missing database schemas</li>
<li>Document storage tables, &quot;upsert&quot; functions, and any configured indexes</li>
<li>Javascript transforms</li>
<li>The Hilo support table</li>
<li>The Event Store schema objects</li>
</ol>
<h2 id="apply-all-outstanding-changes-upfront">Apply All Outstanding Changes Upfront</h2>
<p>To programmatically apply all detectable schema changes upfront when an application is first
bootstrapped, you can use this mechanism:</p>
<pre><code class="language-csharp">&#xD;&#xA;store.Schema.ApplyAllConfiguredChangesToDatabase();&#xD;&#xA;</code></pre>
<h2 id="assert-that-a-schema-matches-the-configuration">Assert that a Schema Matches the Configuration</h2>
<p>As a possible <a href="http://codebetter.com/jeremymiller/2006/04/06/environment-tests-and-self-diagnosing-configuration-with-structuremap/">environment test</a>,
Marten can do a complete check of its known configuration versus the active Postgresql database and assert any differences
by throwing an exception:</p>
<pre><code class="language-csharp">&#xD;&#xA;store.Schema.AssertDatabaseMatchesConfiguration();&#xD;&#xA;</code></pre>
<p>The exception will list out all the DDL changes that are missing.</p>

                </div>
                <hr />
                <nav class="related-links">
                    <span>
                        <strong>Previous: </strong><a href="/v3/documentation/schema/schema">Configuring the Database Schema</a>
                    </span>
                    <span class="pull-right">
                        <strong>Next: </strong><a href="/v3/documentation/schema/exporting">Exporting the Schema Definition</a>
                    </span>
                </nav>
            </div><!--/right-->
        </div><!--/row-->
    </div><!--/container-->
    <footer>
        <ul>
            <li>
                <a href="https://dotnetfoundation.org">
                    <img class="dot-net-foundation-logo" src="https://raw.githubusercontent.com/dotnet/swag/master/logo/dotnetfoundation_v4.png" alt="Supported by the .NET Foundation" />
                </a>
                Supported by the <a href="https://dotnetfoundation.org">.NET Foundation</a>
            </li>
        </ul>
    </footer>
</body>

<foot>
    <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type='text/javascript' src="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/v3/content/prism.js"></script>
    <script type="text/javascript" src="/v3/content/sidebar.js"></script>
    <script type="text/javascript" src="/v3/content/affix.js"></script>

    <script>
        $('#search').keyup(function (e) {
            if (e.keyCode == 13) {
                var search = $('#search').val();

                var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
                url = encodeURI(url);

                //alert(url);

                window.location.href = url;

                e.stopPropagation();
                if (e.cancelBubble != null) e.cancelBubble = true;
                return false;
            }

        });
    </script>
</foot>
</html>
